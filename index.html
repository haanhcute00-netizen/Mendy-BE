<!-- index.html demo -->
<video id="local" autoplay playsinline muted></video>
<video id="remote" autoplay playsinline></video>
<button id="call">Call</button>
<button id="accept">Accept</button>
<button id="hangup">Hang Up</button>
<script type="module">
    import { io } from "https://cdn.skypack.dev/socket.io-client";

    const API = "http://localhost:4000";
    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwicm9sZSI6IkVYUEVSVCIsInR5cCI6ImFjY2VzcyIsImlhdCI6MTc1ODE4MjcxNCwiZXhwIjoxNzU4MTgzNjE0LCJhdWQiOiJoZWFsaW5nLndlYmFwcCIsImlzcyI6ImhlYWxpbmcuYXBpIn0.gXNmZYhaCegCDTPT3HiaHRvfGTrRSGlJAmNYULSnMYs"; // lấy từ login
    const threadId = 2;
    const peerId = 3;

    const localEl = document.getElementById("local");
    const remoteEl = document.getElementById("remote");
    let pc, callId, iceServers;

    const rtc = io(`${API}/rtc`, { auth: { token } });

    async function getIceServers() {
        return await new Promise((resolve) => {
            rtc.timeout(5000).emit("turn:token", {}, (res) => resolve(res?.iceServers || [{ urls: "stun:stun.l.google.com:19302" }]));
        });
    }

    function attach(el, stream) { el.srcObject = stream; }

    async function makePC(kind) {
        iceServers = iceServers || await getIceServers();
        pc = new RTCPeerConnection({ iceServers });
        pc.onicecandidate = (e) => e.candidate && rtc.emit("rtc:candidate", { callId, candidate: e.candidate });
        pc.ontrack = (e) => attach(remoteEl, e.streams[0]);

        const ms = await navigator.mediaDevices.getUserMedia({ audio: true, video: (kind === "VIDEO") });
        ms.getTracks().forEach(t => pc.addTrack(t, ms));
        attach(localEl, ms);
    }

    document.getElementById("call").onclick = async () => {
        const kind = "VIDEO"; // hoặc "AUDIO"
        const ack = await new Promise((resolve) => rtc.emit("call:invite", { threadId, peerId, kind }, resolve));
        if (!ack?.ok) return alert(ack?.error || "invite failed");
        callId = ack.callId;
        await makePC(kind);
        const offer = await pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: (kind === "VIDEO") });
        await pc.setLocalDescription(offer);
        rtc.emit("rtc:offer", { callId, sdp: offer.sdp });
    };

    document.getElementById("accept").onclick = async () => {
        const kind = "VIDEO"; // hoặc "AUDIO"
        rtc.emit("call:accept", { callId }); // set callId từ event incoming
        await makePC(kind);
    };

    document.getElementById("hangup").onclick = () => rtc.emit("call:hangup", { callId });

    rtc.on("call:incoming", ({ callId: id, from, kind }) => {
        callId = id;
        console.log("Incoming call from", from, kind);
        // Hiển thị UI Accept/Reject
    });

    rtc.on("rtc:offer", async ({ sdp }) => {
        await pc.setRemoteDescription({ type: "offer", sdp });
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        rtc.emit("rtc:answer", { callId, sdp: answer.sdp });
    });
    rtc.on("rtc:answer", async ({ sdp }) => { await pc.setRemoteDescription({ type: "answer", sdp }); });
    rtc.on("rtc:candidate", async ({ candidate }) => { try { await pc.addIceCandidate(candidate); } catch { } });

    rtc.on("call:ended", ({ reason }) => {
        console.log("Call ended:", reason);
        pc && pc.close();
    });
</script>