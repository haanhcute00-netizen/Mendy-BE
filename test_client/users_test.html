<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Users Module</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1877f2;
        }

        h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #1877f2;
            padding-bottom: 10px;
        }

        h3 {
            color: #555;
            margin: 15px 0 10px;
        }

        label {
            display: block;
            margin: 8px 0 4px;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }

        input[type="text"],
        input[type="number"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 5px;
        }

        textarea {
            min-height: 60px;
            resize: vertical;
        }

        button {
            background: #1877f2;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin: 5px 5px 5px 0;
        }

        button:hover {
            background: #166fe5;
        }

        .btn-success {
            background: #42b72a;
        }

        .btn-danger {
            background: #fa3e3e;
        }

        .btn-warning {
            background: #f7b928;
            color: #333;
        }

        .btn-secondary {
            background: #65676b;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        #result {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .profile-card {
            border: 1px solid #e4e6eb;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #e4e6eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            color: #050505;
        }

        .profile-handle {
            color: #65676b;
            font-size: 14px;
        }

        .profile-stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #050505;
        }

        .profile-stat-label {
            font-size: 12px;
            color: #65676b;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
        }

        .badge-primary {
            background: #e7f3ff;
            color: #1877f2;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f2f5;
        }

        .info-label {
            color: #65676b;
        }

        .info-value {
            font-weight: 500;
            color: #050505;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e4e6eb;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: #65676b;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: #1877f2;
            border-bottom-color: #1877f2;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .checkbox-label input {
            width: auto;
        }
    </style>
</head>

<body>
    <h1>üë§ Test Users Module</h1>

    <!-- Login -->
    <div class="card">
        <h2>1. ƒêƒÉng nh·∫≠p</h2>
        <div class="grid-2">
            <div>
                <label>Handle</label>
                <input type="text" id="loginHandle" value="seeker1" placeholder="Handle">
            </div>
            <div>
                <label>Password</label>
                <input type="text" id="loginPassword" value="123456">
            </div>
        </div>
        <button onclick="login()">üîê ƒêƒÉng nh·∫≠p</button>
        <div id="loginStatus" class="status"></div>
    </div>

    <!-- My Profile -->
    <div class="card">
        <h2>2. Profile c·ªßa t√¥i</h2>
        <button onclick="getMyProfile()">üë§ L·∫•y Profile</button>
        <button onclick="getMyProfile(true)" class="btn-secondary">üìã Xem JSON ƒë·∫ßy ƒë·ªß</button>
        <div id="myProfileContainer"></div>
    </div>

    <!-- Setup Profile -->
    <div class="card">
        <h2>3. C·∫≠p nh·∫≠t Profile</h2>
        <div class="grid-2">
            <div>
                <label>H·ªç t√™n</label>
                <input type="text" id="fullName" placeholder="Nguy·ªÖn VƒÉn A">
                <label>NƒÉm sinh</label>
                <input type="number" id="yearOfBirth" placeholder="1990" min="1900" max="2010">
                <label>Gi·ªõi t√≠nh</label>
                <select id="gender">
                    <option value="UNSPECIFIED">Kh√¥ng x√°c ƒë·ªãnh</option>
                    <option value="MALE">Nam</option>
                    <option value="FEMALE">N·ªØ</option>
                    <option value="OTHER">Kh√°c</option>
                </select>
            </div>
            <div>
                <label>Role</label>
                <select id="role">
                    <option value="SEEKER">Seeker (Ng∆∞·ªùi t√¨m ki·∫øm)</option>
                    <option value="LISTENER">Listener (Ng∆∞·ªùi l·∫Øng nghe)</option>
                    <option value="EXPERT">Expert (Chuy√™n gia)</option>
                </select>
                <label>Avatar</label>
                <input type="file" id="avatar" accept="image/*">
                <label>T√†i li·ªáu ƒë√≠nh k√®m</label>
                <input type="file" id="attachment" accept=".pdf,.doc,.docx,.txt">
                <div class="checkbox-label">
                    <input type="checkbox" id="isAnonymous" checked>
                    <label for="isAnonymous">·∫®n danh tr√™n h·ªá th·ªëng</label>
                </div>
            </div>
        </div>
        <button onclick="setupProfile()" class="btn-success">üíæ L∆∞u Profile</button>
    </div>

    <!-- Expert Profile -->
    <div class="card">
        <h2>4. Profile Expert (ch·ªâ d√†nh cho Expert)</h2>
        <div class="grid-2">
            <div>
                <label>Chuy√™n m√¥n (c√°ch nhau b·ªüi d·∫•u ph·∫©y)</label>
                <input type="text" id="specialties" placeholder="anxiety, depression, relationship">
                <label>Gi√° m·ªói session (VND)</label>
                <input type="number" id="pricePerSession" placeholder="500000" min="0">
            </div>
            <div>
                <label>Gi·ªõi thi·ªáu b·∫£n th√¢n</label>
                <textarea id="expertIntro" placeholder="T√¥i l√† chuy√™n gia t√¢m l√Ω v·ªõi 5 nƒÉm kinh nghi·ªám..."></textarea>
            </div>
        </div>
        <button onclick="updateExpertProfile()" class="btn-warning">üéì C·∫≠p nh·∫≠t Expert Profile</button>
    </div>

    <!-- Follow/Unfollow -->
    <div class="card">
        <h2>5. Follow / Unfollow</h2>
        <label>User ID</label>
        <input type="number" id="targetUserId" placeholder="ID ng∆∞·ªùi d√πng mu·ªën follow/unfollow">
        <button onclick="followUser()" class="btn-success">‚ûï Follow</button>
        <button onclick="unfollowUser()" class="btn-danger">‚ûñ Unfollow</button>
    </div>

    <!-- Result -->
    <div class="card">
        <h2>üìã Response Log</h2>
        <pre id="result">Ch∆∞a c√≥ request n√†o...</pre>
    </div>

    <script>
        const BASE_URL = 'http://localhost:4000/api/v1';
        let token = localStorage.getItem('token') || '';
        let currentUser = null;

        function log(data) {
            document.getElementById('result').textContent = JSON.stringify(data, null, 2);
        }

        function showStatus(id, msg, isSuccess) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = 'status ' + (isSuccess ? 'success' : 'error');
        }

        async function login() {
            const handle = document.getElementById('loginHandle').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ handle, password })
                });
                const data = await res.json();
                log(data);
                if (data.data?.access_token) {
                    token = data.data.access_token;
                    currentUser = data.data.user;
                    localStorage.setItem('token', token);
                    showStatus('loginStatus', `‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! User: ${currentUser?.handle} (ID: ${currentUser?.id})`, true);
                    // Auto load profile
                    getMyProfile();
                } else {
                    showStatus('loginStatus', '‚ùå ' + (data.message || 'Th·∫•t b·∫°i'), false);
                }
            } catch (err) {
                log({ error: err.message });
                showStatus('loginStatus', '‚ùå L·ªói: ' + err.message, false);
            }
        }

        async function getMyProfile(showRaw = false) {
            if (!token) return alert('ƒêƒÉng nh·∫≠p tr∆∞·ªõc!');
            try {
                const res = await fetch(`${BASE_URL}/profile/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                log(data);

                if (data.success && data.data) {
                    if (showRaw) return; // Just show JSON
                    renderProfile(data.data);
                }
            } catch (err) {
                log({ error: err.message });
            }
        }

        function renderProfile(p) {
            const container = document.getElementById('myProfileContainer');
            const avatar = p.avatar_url
                ? `<img src="${p.avatar_url.startsWith('/') ? 'http://localhost:4000' + p.avatar_url : p.avatar_url}">`
                : p.display_name?.charAt(0) || p.handle?.charAt(0) || 'üë§';

            const roleBadge = {
                'SEEKER': '<span class="badge badge-primary">Seeker</span>',
                'LISTENER': '<span class="badge badge-success">Listener</span>',
                'EXPERT': '<span class="badge badge-warning">Expert</span>',
                'ADMIN': '<span class="badge badge-danger">Admin</span>'
            }[p.role_primary] || '';

            const kycBadge = p.expert_profile?.kyc_status === 'VERIFIED'
                ? '<span class="badge badge-success">‚úì Verified</span>'
                : p.expert_profile?.kyc_status === 'PENDING'
                    ? '<span class="badge badge-warning">Pending</span>'
                    : '';

            const anonymousBadge = p.is_anonymous
                ? '<span class="badge badge-secondary">üîí ·∫®n danh</span>'
                : '<span class="badge badge-primary">üëÅ C√¥ng khai</span>';

            container.innerHTML = `
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">${avatar}</div>
                        <div>
                            <div class="profile-name">${p.display_name || 'Ch∆∞a ƒë·∫∑t t√™n'}</div>
                            <div class="profile-handle">@${p.handle}</div>
                            <div style="margin-top:5px;">${roleBadge} ${kycBadge} ${anonymousBadge}</div>
                        </div>
                    </div>

                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-value">${p.posts_count || 0}</div>
                            <div class="profile-stat-label">B√†i vi·∫øt</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value">${p.followers_count || 0}</div>
                            <div class="profile-stat-label">Followers</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value">${p.following_count || 0}</div>
                            <div class="profile-stat-label">Following</div>
                        </div>
                        ${p.completed_sessions ? `
                        <div class="profile-stat">
                            <div class="profile-stat-value">${p.completed_sessions}</div>
                            <div class="profile-stat-label">Sessions</div>
                        </div>
                        ` : ''}
                    </div>

                    <div class="tabs">
                        <div class="tab active" onclick="showTab('info')">Th√¥ng tin</div>
                        ${p.expert_profile ? '<div class="tab" onclick="showTab(\'expert\')">Expert</div>' : ''}
                        ${p.wallet ? '<div class="tab" onclick="showTab(\'wallet\')">V√≠</div>' : ''}
                    </div>

                    <div id="tab-info" class="tab-content active">
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value">${p.email || 'Ch∆∞a c√≥'} ${p.is_email_verified ? '‚úì' : ''}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ƒêi·ªán tho·∫°i</span>
                            <span class="info-value">${p.phone || 'Ch∆∞a c√≥'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Gi·ªõi t√≠nh</span>
                            <span class="info-value">${p.gender || 'Ch∆∞a x√°c ƒë·ªãnh'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">NƒÉm sinh</span>
                            <span class="info-value">${p.year_of_birth || 'Ch∆∞a c√≥'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tr·∫°ng th√°i</span>
                            <span class="info-value">${p.status}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ng√†y t·∫°o</span>
                            <span class="info-value">${new Date(p.created_at).toLocaleDateString('vi-VN')}</span>
                        </div>
                    </div>

                    ${p.expert_profile ? `
                    <div id="tab-expert" class="tab-content">
                        <div class="info-row">
                            <span class="info-label">Chuy√™n m√¥n</span>
                            <span class="info-value">${(p.expert_profile.specialties || []).join(', ') || 'Ch∆∞a c√≥'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Gi√°/session</span>
                            <span class="info-value">${p.expert_profile.price_per_session?.toLocaleString('vi-VN')} VND</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Rating</span>
                            <span class="info-value">‚≠ê ${p.expert_profile.rating_avg || 'Ch∆∞a c√≥'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Gi·ªõi thi·ªáu</span>
                            <span class="info-value">${p.expert_profile.intro || 'Ch∆∞a c√≥'}</span>
                        </div>
                        ${p.expert_skills?.length ? `
                        <div class="info-row">
                            <span class="info-label">Skills</span>
                            <span class="info-value">${p.expert_skills.map(s => s.name).join(', ')}</span>
                        </div>
                        ` : ''}
                        ${p.expert_experience?.length ? `
                        <div class="info-row">
                            <span class="info-label">Kinh nghi·ªám</span>
                            <span class="info-value">${p.expert_experience.map(e => `${e.position} t·∫°i ${e.organization}`).join('; ')}</span>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    ${p.wallet ? `
                    <div id="tab-wallet" class="tab-content">
                        <div class="info-row">
                            <span class="info-label">S·ªë d∆∞</span>
                            <span class="info-value" style="font-size:18px;color:#42b72a;">${parseFloat(p.wallet.balance || 0).toLocaleString('vi-VN')} VND</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            // Pre-fill form with current data
            if (p.display_name) document.getElementById('fullName').value = p.display_name;
            if (p.year_of_birth) document.getElementById('yearOfBirth').value = p.year_of_birth;
            if (p.gender) document.getElementById('gender').value = p.gender;
            if (p.role_primary) document.getElementById('role').value = p.role_primary;
            if (p.is_anonymous !== undefined) document.getElementById('isAnonymous').checked = p.is_anonymous;

            if (p.expert_profile) {
                if (p.expert_profile.specialties) document.getElementById('specialties').value = p.expert_profile.specialties.join(', ');
                if (p.expert_profile.price_per_session) document.getElementById('pricePerSession').value = p.expert_profile.price_per_session;
                if (p.expert_profile.intro) document.getElementById('expertIntro').value = p.expert_profile.intro;
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`)?.classList.add('active');
            document.getElementById(`tab-${tabName}`)?.classList.add('active');
        }

        async function setupProfile() {
            if (!token) return alert('ƒêƒÉng nh·∫≠p tr∆∞·ªõc!');

            const formData = new FormData();
            formData.append('full_name', document.getElementById('fullName').value);
            formData.append('year_of_birth', document.getElementById('yearOfBirth').value);
            formData.append('gender', document.getElementById('gender').value);
            formData.append('role', document.getElementById('role').value);
            formData.append('is_anonymous', document.getElementById('isAnonymous').checked);

            const avatarFile = document.getElementById('avatar').files[0];
            const attachmentFile = document.getElementById('attachment').files[0];
            if (avatarFile) formData.append('avatar', avatarFile);
            if (attachmentFile) formData.append('attachment', attachmentFile);

            try {
                const res = await fetch(`${BASE_URL}/profile/setup`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();
                log(data);
                if (data.success) {
                    alert('‚úÖ C·∫≠p nh·∫≠t profile th√†nh c√¥ng!');
                    getMyProfile();
                }
            } catch (err) {
                log({ error: err.message });
            }
        }

        async function updateExpertProfile() {
            if (!token) return alert('ƒêƒÉng nh·∫≠p tr∆∞·ªõc!');

            const specialtiesStr = document.getElementById('specialties').value;
            const specialties = specialtiesStr ? specialtiesStr.split(',').map(s => s.trim()).filter(s => s) : [];

            const body = {
                specialties,
                price_per_session: parseInt(document.getElementById('pricePerSession').value) || 0,
                intro: document.getElementById('expertIntro').value
            };

            try {
                const res = await fetch(`${BASE_URL}/profile/expert`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                log(data);
                if (data.success) {
                    alert('‚úÖ C·∫≠p nh·∫≠t expert profile th√†nh c√¥ng!');
                    getMyProfile();
                }
            } catch (err) {
                log({ error: err.message });
            }
        }

        async function followUser() {
            if (!token) return alert('ƒêƒÉng nh·∫≠p tr∆∞·ªõc!');
            const userId = document.getElementById('targetUserId').value;
            if (!userId) return alert('Nh·∫≠p User ID!');

            try {
                const res = await fetch(`${BASE_URL}/follows/follow`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ user_id: parseInt(userId) })
                });
                const data = await res.json();
                log(data);
                if (data.success) {
                    alert('‚úÖ ƒê√£ follow user!');
                    getMyProfile();
                }
            } catch (err) {
                log({ error: err.message });
            }
        }

        async function unfollowUser() {
            if (!token) return alert('ƒêƒÉng nh·∫≠p tr∆∞·ªõc!');
            const userId = document.getElementById('targetUserId').value;
            if (!userId) return alert('Nh·∫≠p User ID!');

            try {
                const res = await fetch(`${BASE_URL}/follows/unfollow`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ user_id: parseInt(userId) })
                });
                const data = await res.json();
                log(data);
                if (data.success) {
                    alert('‚úÖ ƒê√£ unfollow user!');
                    getMyProfile();
                }
            } catch (err) {
                log({ error: err.message });
            }
        }

        // Auto-check token on load
        if (token) {
            showStatus('loginStatus', '‚úÖ ƒê√£ c√≥ token t·ª´ session tr∆∞·ªõc', true);
            getMyProfile();
        }
    </script>
</body>

</html>