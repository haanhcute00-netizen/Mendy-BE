<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Companion - B·∫£ng ƒêi·ªÅu Khi·ªÉn</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin: 3px;
        }

        button:hover {
            opacity: 0.9;
        }

        button.success {
            background: #28a745;
        }

        button.danger {
            background: #dc3545;
        }

        .response {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
        }

        .response pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 11px;
        }

        .auth-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .persona-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
        }

        .persona-card:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .persona-card h3 {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .persona-card .tone {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
        }

        .mood-btn {
            padding: 15px 20px;
            margin: 5px;
            border-radius: 8px;
            font-size: 20px;
        }

        .mood-btn.selected {
            border: 3px solid #667eea;
        }

        .stat-box {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 5px;
            flex: 1;
            min-width: 80px;
        }

        .stat-box .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-box .label {
            font-size: 12px;
            color: #666;
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ü§ñ AI Companion - B·∫£ng ƒêi·ªÅu Khi·ªÉn</h1>

        <div class="auth-section">
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <label>üîê Token x√°c th·ª±c:</label>
                    <input type="text" id="token" placeholder="D√°n JWT token v√†o ƒë√¢y">
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label>üåê ƒê·ªãa ch·ªâ API:</label>
                    <input type="text" id="baseUrl" value="http://localhost:3000/api/v1">
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('persona')">üé≠ Nh√¢n C√°ch</button>
            <button class="tab" onclick="showTab('emotion')">üí≠ C·∫£m X√∫c</button>
            <button class="tab" onclick="showTab('mental')">üß† S·ª©c Kh·ªèe</button>
            <button class="tab" onclick="showTab('wellness')">üßò Ho·∫°t ƒê·ªông</button>
            <button class="tab" onclick="showTab('schedule')">ÔøΩ Le·ªãch Tr√¨nh</button>
            <button class="tab" onclick="showTab('sleep')">üò¥ Gi·∫•c Ng·ªß</button>
            <button class="tab" onclick="showTab('checkin')">üìã Check-in</button>
            <button class="tab" onclick="showTab('notifications')">üîî Th√¥ng B√°o</button>
            <button class="tab" onclick="showTab('chat')">üí¨ Chat</button>
            <button class="tab" onclick="showTab('admin')">üëë Admin</button>
        </div>

        <!-- TAB NH√ÇN C√ÅCH -->
        <div id="persona" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>üé≠ Danh S√°ch Nh√¢n C√°ch AI</h2>
                    <button onclick="loadPersonas()">T·∫£i danh s√°ch</button>
                    <div id="personasList"></div>
                    <div class="response" id="personasResponse"></div>
                </div>
                <div class="card">
                    <h2>‚öôÔ∏è C√†i ƒê·∫∑t AI C·ªßa T√¥i</h2>
                    <button onclick="getSettings()">Xem c√†i ƒë·∫∑t</button>
                    <button onclick="updateSettings()" class="success">L∆∞u</button>
                    <div class="form-group" style="margin-top:10px;">
                        <label>ID Nh√¢n c√°ch:</label>
                        <input type="number" id="settingsPersonaId">
                    </div>
                    <div class="form-group">
                        <label>AI g·ªçi b·∫°n l√†:</label>
                        <input type="text" id="customNickname" placeholder="Con y√™u, Em ∆°i...">
                    </div>
                    <div class="form-group">
                        <label>B·∫°n g·ªçi AI l√†:</label>
                        <input type="text" id="userNickname" placeholder="M·∫π, Anh y√™u...">
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="notificationEnabled" checked> B·∫≠t th√¥ng b√°o</label>
                        <label><input type="checkbox" id="morningCheckin" checked> Ch√†o bu·ªïi s√°ng</label>
                        <label><input type="checkbox" id="eveningCheckin" checked> Ch√†o bu·ªïi t·ªëi</label>
                        <label><input type="checkbox" id="randomMessages" checked> Tin nh·∫Øn ng·∫´u nhi√™n</label>
                    </div>
                    <div class="response" id="settingsResponse"></div>
                </div>
                <div class="card">
                    <h2>üìù B·ªô Nh·ªõ AI (Context)</h2>
                    <button onclick="getContext()">Xem b·ªô nh·ªõ</button>
                    <button onclick="saveContext()" class="success">L∆∞u</button>
                    <div class="form-group" style="margin-top:10px;">
                        <label>Lo·∫°i:</label>
                        <select id="contextType">
                            <option value="preference">S·ªü th√≠ch</option>
                            <option value="memory">K·ª∑ ni·ªám</option>
                            <option value="topic">Ch·ªß ƒë·ªÅ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√™n:</label>
                        <input type="text" id="contextKey" placeholder="c√¥ng vi·ªác, s·ªü th√≠ch...">
                    </div>
                    <div class="form-group">
                        <label>Gi√° tr·ªã:</label>
                        <input type="text" id="contextValue" placeholder="l·∫≠p tr√¨nh vi√™n, ch∆°i game...">
                    </div>
                    <div class="response" id="contextResponse"></div>
                </div>
            </div>
        </div>

        <!-- TAB C·∫¢M X√öC -->
        <div id="emotion" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üìä L·ªãch S·ª≠ C·∫£m X√∫c</h2>
                    <div class="form-group">
                        <label>S·ªë ng√†y:</label>
                        <input type="number" id="emotionDays" value="7" min="1" max="90">
                    </div>
                    <button onclick="getEmotionTimeline()">Xem timeline</button>
                    <button onclick="getEmotionStats()">Xem th·ªëng k√™</button>
                    <div class="response" id="emotionResponse"></div>
                </div>
                <div class="card">
                    <h2>üß† Tr·∫°ng Th√°i Tinh Th·∫ßn Hi·ªán T·∫°i</h2>
                    <button onclick="getMentalState()">Xem tr·∫°ng th√°i</button>
                    <div id="mentalStateDisplay"></div>
                    <div class="response" id="mentalStateResponse"></div>
                </div>
            </div>
        </div>

        <!-- TAB S·ª®C KH·ªéE TINH TH·∫¶N -->
        <div id="mental" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üìã ƒê√°nh Gi√° S·ª©c Kh·ªèe Tinh Th·∫ßn</h2>
                    <button onclick="createAssessment()">T·∫°o ƒë√°nh gi√° m·ªõi</button>
                    <button onclick="getLatestAssessment()">Xem g·∫ßn nh·∫•t</button>
                    <button onclick="getAssessmentHistory()">L·ªãch s·ª≠</button>
                    <div class="response" id="assessmentResponse"></div>
                </div>
                <div class="card">
                    <h2>üìà K·∫øt Qu·∫£ ƒê√°nh Gi√°</h2>
                    <div id="assessmentDisplay"></div>
                </div>
            </div>
        </div>

        <!-- TAB HO·∫†T ƒê·ªòNG -->
        <div id="wellness" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üßò Ghi Nh·∫≠n Ho·∫°t ƒê·ªông ChƒÉm S√≥c</h2>
                    <div class="form-group">
                        <label>Lo·∫°i ho·∫°t ƒë·ªông:</label>
                        <select id="wellnessType">
                            <option value="breathing">üå¨Ô∏è B√†i t·∫≠p th·ªü</option>
                            <option value="meditation">üßò Thi·ªÅn</option>
                            <option value="journaling">üìù Vi·∫øt nh·∫≠t k√Ω</option>
                            <option value="exercise">üèÉ T·∫≠p th·ªÉ d·ª•c</option>
                            <option value="gratitude">üôè Bi·∫øt ∆°n</option>
                            <option value="grounding">üåç Grounding</option>
                            <option value="affirmation">üí™ Kh·∫≥ng ƒë·ªãnh</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Th·ªùi gian (ph√∫t):</label>
                        <input type="number" id="wellnessDuration" value="5" min="1">
                    </div>
                    <div class="form-group">
                        <label>T√¢m tr·∫°ng tr∆∞·ªõc:</label>
                        <select id="moodBefore">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="great">üòÑ Tuy·ªát v·ªùi</option>
                            <option value="good">üôÇ T·ªët</option>
                            <option value="okay">üòê B√¨nh th∆∞·ªùng</option>
                            <option value="bad">üòî Kh√¥ng t·ªët</option>
                            <option value="terrible">üò¢ R·∫•t t·ªá</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√¢m tr·∫°ng sau:</label>
                        <select id="moodAfter">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="great">üòÑ Tuy·ªát v·ªùi</option>
                            <option value="good">üôÇ T·ªët</option>
                            <option value="okay">üòê B√¨nh th∆∞·ªùng</option>
                            <option value="bad">üòî Kh√¥ng t·ªët</option>
                            <option value="terrible">üò¢ R·∫•t t·ªá</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Hi·ªáu qu·∫£ (1-5):</label>
                        <input type="number" id="wellnessRating" value="3" min="1" max="5">
                    </div>
                    <button onclick="logWellness()" class="success">Ghi nh·∫≠n</button>
                    <div class="response" id="wellnessLogResponse"></div>
                </div>
                <div class="card">
                    <h2>üí° G·ª£i √ù Ho·∫°t ƒê·ªông</h2>
                    <button onclick="getWellnessSuggestions()">Xem g·ª£i √Ω</button>
                    <button onclick="getWellnessHistory()">L·ªãch s·ª≠</button>
                    <button onclick="getWellnessStats()">Th·ªëng k√™</button>
                    <div class="response" id="wellnessResponse"></div>
                </div>
            </div>
        </div>

        <!-- TAB L·ªäCH TR√åNH -->
        <div id="schedule" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>ÔøΩ T·∫°o L·ªãch M√¢·ªõi</h2>
                    <div class="form-group">
                        <label>Ti√™u ƒë·ªÅ:</label>
                        <input type="text" id="scheduleTitle" placeholder="T√™n c√¥ng vi·ªác...">
                    </div>
                    <div class="form-group">
                        <label>Lo·∫°i:</label>
                        <select id="scheduleType">
                            <option value="work">üíº C√¥ng vi·ªác</option>
                            <option value="study">üìö H·ªçc t·∫≠p</option>
                            <option value="health">üè• S·ª©c kh·ªèe</option>
                            <option value="exercise">üèÉ T·∫≠p luy·ªán</option>
                            <option value="medication">üíä U·ªëng thu·ªëc</option>
                            <option value="meal">üçΩÔ∏è B·ªØa ƒÉn</option>
                            <option value="appointment">üìû Cu·ªôc h·∫πn</option>
                            <option value="deadline">‚è∞ Deadline</option>
                            <option value="reminder">üîî Nh·∫Øc nh·ªü</option>
                            <option value="custom">üìù Kh√°c</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Th·ªùi gian b·∫Øt ƒë·∫ßu:</label>
                        <input type="datetime-local" id="scheduleStartAt">
                    </div>
                    <div class="form-group">
                        <label>ƒê·ªô ∆∞u ti√™n (1-5):</label>
                        <input type="number" id="schedulePriority" value="2" min="1" max="5">
                    </div>
                    <button onclick="createSchedule()" class="success">T·∫°o l·ªãch</button>
                    <div class="response" id="scheduleCreateResponse"></div>
                </div>
                <div class="card">
                    <h2>üìã L·ªãch C·ªßa T√¥i</h2>
                    <button onclick="getTodaySchedules()">H√¥m nay</button>
                    <button onclick="getUpcomingSchedules()">S·∫Øp t·ªõi</button>
                    <button onclick="getAllSchedules()">T·∫•t c·∫£</button>
                    <button onclick="getAISuggestions()" class="success">ü§ñ AI G·ª£i √Ω</button>
                    <div class="response" id="scheduleListResponse"></div>
                </div>
            </div>
        </div>

        <!-- TAB GI·∫§C NG·ª¶ -->
        <div id="sleep" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üò¥ Ghi Nh·∫≠n Gi·∫•c Ng·ªß</h2>
                    <div class="form-group">
                        <label>Gi·ªù ƒëi ng·ªß:</label>
                        <input type="datetime-local" id="sleepAt">
                    </div>
                    <div class="form-group">
                        <label>Gi·ªù th·ª©c d·∫≠y:</label>
                        <input type="datetime-local" id="wakeAt">
                    </div>
                    <div class="form-group">
                        <label>Ch·∫•t l∆∞·ª£ng (1-5):</label>
                        <input type="range" id="sleepQualityLog" min="1" max="5" value="3">
                        <span id="sleepQualityLogValue">3</span>
                    </div>
                    <div class="form-group">
                        <label>S·ªë l·∫ßn th·ª©c gi·∫•c:</label>
                        <input type="number" id="sleepInterruptions" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Y·∫øu t·ªë ·∫£nh h∆∞·ªüng:</label>
                        <label><input type="checkbox" value="caffeine"> Caffeine</label>
                        <label><input type="checkbox" value="stress"> Stress</label>
                        <label><input type="checkbox" value="screen_time"> M√†n h√¨nh</label>
                        <label><input type="checkbox" value="exercise"> T·∫≠p luy·ªán</label>
                    </div>
                    <button onclick="logSleep()" class="success">Ghi nh·∫≠n</button>
                    <div class="response" id="sleepLogResponse"></div>
                </div>
                <div class="card">
                    <h2>üìä Ph√¢n T√≠ch Gi·∫•c Ng·ªß</h2>
                    <button onclick="getSleepHistory()">L·ªãch s·ª≠</button>
                    <button onclick="getSleepAnalysis()">Ph√¢n t√≠ch</button>
                    <div class="response" id="sleepAnalysisResponse"></div>
                </div>
            </div>
        </div>

        <!-- TAB CHECK-IN -->
        <div id="checkin" class="tab-content">
            <div class="grid">
                <div class="card full-width">
                    <h2>üìã Check-in T√¢m Tr·∫°ng H√†ng Ng√†y</h2>
                    <div style="text-align: center; margin: 20px 0;">
                        <p style="margin-bottom: 10px; font-weight: bold; font-size: 18px;">H√¥m nay b·∫°n c·∫£m th·∫•y th·∫ø
                            n√†o?</p>
                        <button class="mood-btn" onclick="selectMood('great')">üòÑ</button>
                        <button class="mood-btn" onclick="selectMood('good')">üôÇ</button>
                        <button class="mood-btn" onclick="selectMood('okay')">üòê</button>
                        <button class="mood-btn" onclick="selectMood('bad')">üòî</button>
                        <button class="mood-btn" onclick="selectMood('terrible')">üò¢</button>
                        <p style="margin-top:5px; font-size:12px; color:#666;">Tuy·ªát v·ªùi - T·ªët - B√¨nh th∆∞·ªùng - Kh√¥ng t·ªët
                            - R·∫•t t·ªá</p>
                    </div>
                    <input type="hidden" id="selectedMood" value="">
                    <div class="grid" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>M·ª©c nƒÉng l∆∞·ª£ng (1-5):</label>
                            <input type="range" id="energyLevel" min="1" max="5" value="3">
                            <span id="energyValue">3</span>
                        </div>
                        <div class="form-group">
                            <label>M·ª©c stress (1-5):</label>
                            <input type="range" id="stressLevel" min="1" max="5" value="3">
                            <span id="stressValue">3</span>
                        </div>
                        <div class="form-group">
                            <label>S·ªë gi·ªù ng·ªß:</label>
                            <input type="number" id="sleepHours" value="7" min="0" max="24" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Ch·∫•t l∆∞·ª£ng gi·∫•c ng·ªß (1-5):</label>
                            <input type="range" id="sleepQuality" min="1" max="5" value="3">
                            <span id="sleepValue">3</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>3 ƒëi·ªÅu b·∫°n bi·∫øt ∆°n h√¥m nay:</label>
                        <input type="text" id="gratitude1" placeholder="1. ...">
                        <input type="text" id="gratitude2" placeholder="2. ..." style="margin-top:5px;">
                        <input type="text" id="gratitude3" placeholder="3. ..." style="margin-top:5px;">
                    </div>
                    <div class="form-group">
                        <label>ƒêi·ªÅu lo l·∫Øng ch√≠nh h√¥m nay:</label>
                        <textarea id="concerns" rows="2" placeholder="B·∫°n ƒëang nghƒ© g√¨?"></textarea>
                    </div>
                    <button onclick="submitCheckin()" class="success"
                        style="width:100%; padding:15px; font-size:16px;">‚úÖ G·ª≠i Check-in</button>
                </div>
                <div class="card">
                    <h2>üìÖ L·ªãch S·ª≠ Check-in</h2>
                    <button onclick="getTodayCheckin()">Check-in h√¥m nay</button>
                    <button onclick="getCheckinHistory()">L·ªãch s·ª≠ 30 ng√†y</button>
                    <div class="response" id="checkinResponse"></div>
                </div>
            </div>
        </div>

        <!-- TAB TH√îNG B√ÅO -->
        <div id="notifications" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üîî Th√¥ng B√°o C·ªßa T√¥i</h2>
                    <button onclick="getNotifications()">Xem th√¥ng b√°o</button>
                    <button onclick="scheduleRandom()" class="success">L√™n l·ªãch tin ng·∫´u nhi√™n</button>
                    <div class="response" id="notifResponse"></div>
                </div>
                <div class="card">
                    <h2>üìÖ L√™n L·ªãch Th√¥ng B√°o</h2>
                    <div class="form-group">
                        <label>Lo·∫°i:</label>
                        <select id="notifType">
                            <option value="reminder">Nh·∫Øc nh·ªü</option>
                            <option value="checkin">Check-in</option>
                            <option value="random">Ng·∫´u nhi√™n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>N·ªôi dung:</label>
                        <textarea id="notifContent" rows="2" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Th·ªùi gian g·ª≠i:</label>
                        <input type="datetime-local" id="notifScheduledAt">
                    </div>
                    <button onclick="scheduleNotification()">L√™n l·ªãch</button>
                </div>
            </div>
        </div>

        <!-- TAB TR√í CHUY·ªÜN -->
        <div id="chat" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üí¨ Tr√≤ Chuy·ªán V·ªõi AI</h2>
                    <div class="form-group">
                        <label>Tin nh·∫Øn c·ªßa b·∫°n:</label>
                        <textarea id="chatMessage" rows="3" placeholder="Nh·∫≠p tin nh·∫Øn..."></textarea>
                    </div>
                    <button onclick="sendChat()" class="success" style="width:100%; padding:12px;">üì§ G·ª≠i tin
                        nh·∫Øn</button>
                    <div id="chatDisplay"
                        style="margin-top:15px; max-height:350px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; padding:10px; background:#fafafa;">
                    </div>
                </div>
                <div class="card">
                    <h2>üìú L·ªãch S·ª≠ Tr√≤ Chuy·ªán</h2>
                    <button onclick="loadChatHistory()">T·∫£i l·ªãch s·ª≠</button>
                    <button onclick="clearChatHistory()" class="danger">X√≥a l·ªãch s·ª≠</button>
                    <div class="form-group" style="margin-top:10px;">
                        <label>S·ªë tin nh·∫Øn:</label>
                        <input type="number" id="chatHistoryLimit" value="50" min="10" max="200">
                    </div>
                    <div class="response" id="chatHistoryResponse"></div>
                </div>
            </div>
        </div>

        <!-- TAB QU·∫¢N TR·ªä -->
        <div id="admin" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üëë Qu·∫£n Tr·ªã - Th√¥ng B√°o</h2>
                    <button onclick="adminScheduleMorning()">L√™n l·ªãch ch√†o s√°ng</button>
                    <button onclick="adminScheduleEvening()">L√™n l·ªãch ch√†o t·ªëi</button>
                    <button onclick="adminGetPending()">Xem ƒëang ch·ªù</button>
                    <button onclick="adminCleanup()" class="danger">D·ªçn d·∫πp c≈©</button>
                    <div class="response" id="adminNotifResponse"></div>
                </div>
                <div class="card">
                    <h2>üö® Ng∆∞·ªùi D√πng C·∫ßn H·ªó Tr·ª£</h2>
                    <button onclick="adminGetUsersNeedingAttention()">Xem danh s√°ch</button>
                    <p style="margin-top:10px; font-size:12px; color:#666;">Hi·ªÉn th·ªã users c√≥ stress cao, vulnerability
                        cao, ho·∫∑c nhi·ªÅu ng√†y ti√™u c·ª±c li√™n ti·∫øp.</p>
                    <div class="response" id="adminUsersResponse"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const getHeaders = () => ({
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${document.getElementById('token').value}`
        });
        const getBaseUrl = () => document.getElementById('baseUrl').value;
        const showResponse = (id, data) => {
            document.getElementById(id).innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        };

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Nh√¢n c√°ch
        async function loadPersonas() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/personas`);
            const data = await res.json();
            showResponse('personasResponse', data);
            if (data.data) {
                document.getElementById('personasList').innerHTML = data.data.map(p =>
                    `<div class="persona-card" onclick="document.getElementById('settingsPersonaId').value=${p.id}">
                        <h3>${p.display_name}</h3><span class="tone">${p.tone}</span> ID: ${p.id}
                    </div>`
                ).join('');
            }
        }

        async function getSettings() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/settings`, { headers: getHeaders() });
            const data = await res.json();
            showResponse('settingsResponse', data);
            if (data.data) {
                const s = data.data;
                document.getElementById('settingsPersonaId').value = s.persona_id || '';
                document.getElementById('customNickname').value = s.custom_nickname || '';
                document.getElementById('userNickname').value = s.user_nickname || '';
                document.getElementById('notificationEnabled').checked = s.notification_enabled;
                document.getElementById('morningCheckin').checked = s.morning_checkin;
                document.getElementById('eveningCheckin').checked = s.evening_checkin;
                document.getElementById('randomMessages').checked = s.random_messages;
            }
        }

        async function updateSettings() {
            const body = {
                persona_id: parseInt(document.getElementById('settingsPersonaId').value) || null,
                custom_nickname: document.getElementById('customNickname').value || null,
                user_nickname: document.getElementById('userNickname').value || null,
                notification_enabled: document.getElementById('notificationEnabled').checked,
                morning_checkin: document.getElementById('morningCheckin').checked,
                evening_checkin: document.getElementById('eveningCheckin').checked,
                random_messages: document.getElementById('randomMessages').checked
            };
            const res = await fetch(`${getBaseUrl()}/ai-companion/settings`, { method: 'POST', headers: getHeaders(), body: JSON.stringify(body) });
            showResponse('settingsResponse', await res.json());
        }

        async function getContext() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/context`, { headers: getHeaders() });
            showResponse('contextResponse', await res.json());
        }

        async function saveContext() {
            const body = {
                context_type: document.getElementById('contextType').value,
                key: document.getElementById('contextKey').value,
                value: document.getElementById('contextValue').value,
                importance: 3
            };
            const res = await fetch(`${getBaseUrl()}/ai-companion/context`, { method: 'POST', headers: getHeaders(), body: JSON.stringify(body) });
            showResponse('contextResponse', await res.json());
        }

        // C·∫£m x√∫c
        async function getEmotionTimeline() {
            const days = document.getElementById('emotionDays').value;
            const res = await fetch(`${getBaseUrl()}/ai-companion/emotion/timeline?days=${days}`, { headers: getHeaders() });
            showResponse('emotionResponse', await res.json());
        }

        async function getEmotionStats() {
            const days = document.getElementById('emotionDays').value;
            const res = await fetch(`${getBaseUrl()}/ai-companion/emotion/stats?days=${days}`, { headers: getHeaders() });
            showResponse('emotionResponse', await res.json());
        }

        async function getMentalState() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/mental-state`, { headers: getHeaders() });
            const data = await res.json();
            showResponse('mentalStateResponse', data);
            if (data.data) {
                const s = data.data;
                document.getElementById('mentalStateDisplay').innerHTML = `
                    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;">
                        <div class="stat-box"><div class="value">${s.current_mood || 'N/A'}</div><div class="label">T√¢m tr·∫°ng</div></div>
                        <div class="stat-box"><div class="value">${s.stress_level || 0}/10</div><div class="label">Stress</div></div>
                        <div class="stat-box"><div class="value">${s.anxiety_level || 0}/10</div><div class="label">Lo √¢u</div></div>
                        <div class="stat-box"><div class="value">${s.energy_level || 5}/10</div><div class="label">NƒÉng l∆∞·ª£ng</div></div>
                    </div>
                    <p style="margin-top:10px;color:#666;font-size:13px;">üìù ${(s.interpretation || []).join(' | ')}</p>
                `;
            }
        }

        // ƒê√°nh gi√°
        async function createAssessment() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/assessment`, { method: 'POST', headers: getHeaders(), body: JSON.stringify({ type: 'manual' }) });
            const data = await res.json();
            showResponse('assessmentResponse', data);
            displayAssessment(data.data);
        }

        async function getLatestAssessment() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/assessment/latest`, { headers: getHeaders() });
            const data = await res.json();
            showResponse('assessmentResponse', data);
            displayAssessment(data.data);
        }

        async function getAssessmentHistory() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/assessment/history`, { headers: getHeaders() });
            showResponse('assessmentResponse', await res.json());
        }

        function displayAssessment(a) {
            if (!a) return;
            const riskColors = { low: '#28a745', moderate: '#ffc107', high: '#fd7e14', critical: '#dc3545' };
            const riskLabels = { low: 'Th·∫•p', moderate: 'Trung b√¨nh', high: 'Cao', critical: 'Nghi√™m tr·ªçng' };
            document.getElementById('assessmentDisplay').innerHTML = `
                <div style="padding:15px;background:${riskColors[a.risk_level] || '#ccc'};color:white;border-radius:8px;text-align:center;">
                    <h3>M·ª©c ƒë·ªô r·ªßi ro: ${riskLabels[a.risk_level] || a.risk_level}</h3>
                    <p>ƒêi·ªÉm ki·ªát s·ª©c: ${a.burnout_score}/100</p>
                </div>
                <div style="margin-top:15px;">
                    <h4>üí° Khuy·∫øn ngh·ªã:</h4>
                    <ul>${(a.recommendations || []).map(r => `<li>${r.message}</li>`).join('')}</ul>
                </div>
            `;
        }

        // Ho·∫°t ƒë·ªông chƒÉm s√≥c
        async function logWellness() {
            const body = {
                activity_type: document.getElementById('wellnessType').value,
                duration_minutes: parseInt(document.getElementById('wellnessDuration').value),
                mood_before: document.getElementById('moodBefore').value || null,
                mood_after: document.getElementById('moodAfter').value || null,
                effectiveness_rating: parseInt(document.getElementById('wellnessRating').value)
            };
            const res = await fetch(`${getBaseUrl()}/ai-companion/wellness/log`, { method: 'POST', headers: getHeaders(), body: JSON.stringify(body) });
            showResponse('wellnessLogResponse', await res.json());
        }

        async function getWellnessSuggestions() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/wellness/suggestions`, { headers: getHeaders() });
            showResponse('wellnessResponse', await res.json());
        }

        async function getWellnessHistory() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/wellness/history`, { headers: getHeaders() });
            showResponse('wellnessResponse', await res.json());
        }

        async function getWellnessStats() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/wellness/stats`, { headers: getHeaders() });
            showResponse('wellnessResponse', await res.json());
        }

        // Check-in
        function selectMood(mood) {
            document.getElementById('selectedMood').value = mood;
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        async function submitCheckin() {
            const mood = document.getElementById('selectedMood').value;
            if (!mood) { alert('Vui l√≤ng ch·ªçn t√¢m tr·∫°ng'); return; }
            const gratitudes = [
                document.getElementById('gratitude1').value,
                document.getElementById('gratitude2').value,
                document.getElementById('gratitude3').value
            ].filter(g => g);
            const body = {
                mood,
                mood_score: { great: 5, good: 4, okay: 3, bad: 2, terrible: 1 }[mood],
                energy_level: parseInt(document.getElementById('energyLevel').value),
                stress_level: parseInt(document.getElementById('stressLevel').value),
                sleep_hours: parseFloat(document.getElementById('sleepHours').value),
                sleep_quality: parseInt(document.getElementById('sleepQuality').value),
                gratitude_notes: gratitudes,
                concerns: document.getElementById('concerns').value || null
            };
            const res = await fetch(`${getBaseUrl()}/ai-companion/checkin`, { method: 'POST', headers: getHeaders(), body: JSON.stringify(body) });
            const data = await res.json();
            showResponse('checkinResponse', data);
            if (data.success) alert('‚úÖ Check-in th√†nh c√¥ng!');
        }

        async function getTodayCheckin() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/checkin/today`, { headers: getHeaders() });
            showResponse('checkinResponse', await res.json());
        }

        async function getCheckinHistory() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/checkin/history`, { headers: getHeaders() });
            showResponse('checkinResponse', await res.json());
        }

        // Sliders
        document.getElementById('energyLevel').oninput = e => document.getElementById('energyValue').textContent = e.target.value;
        document.getElementById('stressLevel').oninput = e => document.getElementById('stressValue').textContent = e.target.value;
        document.getElementById('sleepQuality').oninput = e => document.getElementById('sleepValue').textContent = e.target.value;

        // L·ªãch tr√¨nh
        async function createSchedule() {
            const body = {
                title: document.getElementById('scheduleTitle').value,
                schedule_type: document.getElementById('scheduleType').value,
                start_at: new Date(document.getElementById('scheduleStartAt').value).toISOString(),
                priority: parseInt(document.getElementById('schedulePriority').value)
            };
            if (!body.title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ'); return; }
            const res = await fetch(`${getBaseUrl()}/ai-companion/schedule`, { method: 'POST', headers: getHeaders(), body: JSON.stringify(body) });
            showResponse('scheduleCreateResponse', await res.json());
        }

        async function getTodaySchedules() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/schedule/today`, { headers: getHeaders() });
            showResponse('scheduleListResponse', await res.json());
        }

        async function getUpcomingSchedules() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/schedule/upcoming`, { headers: getHeaders() });
            showResponse('scheduleListResponse', await res.json());
        }

        async function getAllSchedules() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/schedule`, { headers: getHeaders() });
            showResponse('scheduleListResponse', await res.json());
        }

        async function getAISuggestions() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/schedule/ai-suggest`, { headers: getHeaders() });
            showResponse('scheduleListResponse', await res.json());
        }

        // Gi·∫•c ng·ªß
        async function logSleep() {
            const factors = [];
            document.querySelectorAll('#sleep input[type="checkbox"]:checked').forEach(cb => factors.push(cb.value));
            const body = {
                sleep_at: document.getElementById('sleepAt').value ? new Date(document.getElementById('sleepAt').value).toISOString() : null,
                wake_at: document.getElementById('wakeAt').value ? new Date(document.getElementById('wakeAt').value).toISOString() : null,
                quality: parseInt(document.getElementById('sleepQualityLog').value),
                interruptions: parseInt(document.getElementById('sleepInterruptions').value),
                factors
            };
            const res = await fetch(`${getBaseUrl()}/ai-companion/sleep/log`, { method: 'POST', headers: getHeaders(), body: JSON.stringify(body) });
            showResponse('sleepLogResponse', await res.json());
        }

        async function getSleepHistory() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/sleep/history`, { headers: getHeaders() });
            showResponse('sleepAnalysisResponse', await res.json());
        }

        async function getSleepAnalysis() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/sleep/analysis`, { headers: getHeaders() });
            showResponse('sleepAnalysisResponse', await res.json());
        }

        document.getElementById('sleepQualityLog').oninput = e => document.getElementById('sleepQualityLogValue').textContent = e.target.value;

        // Th√¥ng b√°o
        async function getNotifications() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/notifications`, { headers: getHeaders() });
            showResponse('notifResponse', await res.json());
        }

        async function scheduleNotification() {
            const body = {
                type: document.getElementById('notifType').value,
                content: document.getElementById('notifContent').value,
                scheduled_at: new Date(document.getElementById('notifScheduledAt').value).toISOString()
            };
            const res = await fetch(`${getBaseUrl()}/ai-companion/notifications/schedule`, { method: 'POST', headers: getHeaders(), body: JSON.stringify(body) });
            showResponse('notifResponse', await res.json());
        }

        async function scheduleRandom() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/notifications/random`, { method: 'POST', headers: getHeaders() });
            showResponse('notifResponse', await res.json());
        }

        // Tr√≤ chuy·ªán
        let chatMessages = [];

        function renderChat() {
            const display = document.getElementById('chatDisplay');
            if (chatMessages.length === 0) {
                display.innerHTML = '<p style="color:#999; text-align:center;">Ch∆∞a c√≥ tin nh·∫Øn. H√£y b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán!</p>';
                return;
            }
            display.innerHTML = chatMessages.map(m => `
                <div style="margin:8px 0; padding:10px; border-radius:12px; max-width:85%; 
                    ${m.role === 'user'
                    ? 'background:#667eea; color:white; margin-left:auto; text-align:right;'
                    : 'background:#e9ecef; color:#333;'}">
                    <small style="opacity:0.7;">${m.role === 'user' ? 'üë§ B·∫°n' : 'ü§ñ AI'}</small><br>
                    ${m.content}
                    ${m.created_at ? `<br><small style="opacity:0.5;">${new Date(m.created_at).toLocaleString('vi-VN')}</small>` : ''}
                </div>
            `).join('');
            display.scrollTop = display.scrollHeight;
        }

        async function sendChat() {
            const input = document.getElementById('chatMessage');
            const message = input.value.trim();
            if (!message) { alert('Vui l√≤ng nh·∫≠p tin nh·∫Øn'); return; }

            // Add user message to display immediately
            chatMessages.push({ role: 'user', content: message });
            renderChat();
            input.value = '';

            try {
                const res = await fetch(`${getBaseUrl()}/ai/chat`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ message })
                });
                const data = await res.json();

                if (data.aiMessage) {
                    chatMessages.push({ role: 'ai', content: data.aiMessage });
                    renderChat();
                }

                // Show experts if any
                if (data.suggestions?.experts?.length > 0) {
                    const expertInfo = `\n\nüí° G·ª£i √Ω chuy√™n gia:\n${data.suggestions.experts.map(e => `‚Ä¢ ${e.display_name}`).join('\n')}`;
                    chatMessages.push({ role: 'ai', content: expertInfo });
                    renderChat();
                }
            } catch (err) {
                chatMessages.push({ role: 'ai', content: '‚ùå L·ªói: ' + err.message });
                renderChat();
            }
        }

        async function loadChatHistory() {
            const limit = document.getElementById('chatHistoryLimit').value;
            try {
                const res = await fetch(`${getBaseUrl()}/ai/history?limit=${limit}`, { headers: getHeaders() });
                const data = await res.json();
                showResponse('chatHistoryResponse', data);

                if (data.data) {
                    chatMessages = data.data;
                    renderChat();
                }
            } catch (err) {
                showResponse('chatHistoryResponse', { error: err.message });
            }
        }

        async function clearChatHistory() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ tr√≤ chuy·ªán?')) return;
            try {
                const res = await fetch(`${getBaseUrl()}/ai/history`, { method: 'DELETE', headers: getHeaders() });
                const data = await res.json();
                showResponse('chatHistoryResponse', data);
                chatMessages = [];
                renderChat();
            } catch (err) {
                showResponse('chatHistoryResponse', { error: err.message });
            }
        }

        // Qu·∫£n tr·ªã
        async function adminScheduleMorning() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/notifications/admin/schedule-morning`, { method: 'POST', headers: getHeaders() });
            showResponse('adminNotifResponse', await res.json());
        }

        async function adminScheduleEvening() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/notifications/admin/schedule-evening`, { method: 'POST', headers: getHeaders() });
            showResponse('adminNotifResponse', await res.json());
        }

        async function adminGetPending() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/notifications/admin/pending`, { headers: getHeaders() });
            showResponse('adminNotifResponse', await res.json());
        }

        async function adminCleanup() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√°c th√¥ng b√°o c≈©?')) return;
            const res = await fetch(`${getBaseUrl()}/ai-companion/notifications/admin/cleanup`, { method: 'POST', headers: getHeaders() });
            showResponse('adminNotifResponse', await res.json());
        }

        async function adminGetUsersNeedingAttention() {
            const res = await fetch(`${getBaseUrl()}/ai-companion/admin/users-needing-attention`, { headers: getHeaders() });
            showResponse('adminUsersResponse', await res.json());
        }

        // Kh·ªüi t·∫°o
        document.getElementById('notifScheduledAt').value = new Date(Date.now() + 3600000).toISOString().slice(0, 16);
        document.getElementById('scheduleStartAt').value = new Date(Date.now() + 3600000).toISOString().slice(0, 16);

        // Set default sleep times
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        yesterday.setHours(23, 0, 0, 0);
        document.getElementById('sleepAt').value = yesterday.toISOString().slice(0, 16);

        const today = new Date();
        today.setHours(7, 0, 0, 0);
        document.getElementById('wakeAt').value = today.toISOString().slice(0, 16);
    </script>
</body>

</html>